<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Let's Chat</title>
    <!-- <link rel='stylesheet' type='text/css' media='screen' href='style.css' defer> -->
    <!-- <script src="./chat.js" defer></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous" defer>
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous" defer></script>
    <link rel="stylesheet" href="style.css">
    <style>
      body{
  background-image: url(chatBackground.jpg);
  background-repeat:no-repeat;
  background-size: cover;
  background-attachment: fixed;
}
section{
margin: 2.5rem auto;
border-radius: 10px;
padding: 1rem;
}
.sigunUp{
  font-family: sans-serif;
  text-align: center;
  text-decoration: none;
  padding-top: 0.5rem;
  opacity: 70%;
}
#userLogged {
width: 50%;

}
    </style>
</head>
  <body>
    <header>
        <h1 class=" sigunUp">Let's Chat</h1>
    </header>
    <section id="userInfo" class="container">
        <span id = "userLogged" class="d-inline form-control">Logged in as : </span>
        <span id = "currentGroupName" class="d-inline form-control">Current Group: </span>
        <span id = "sign-out-button" class="btn btn-secondary d-inline float-end ms-2">Sign Out</span>
        <div id="group-list" class = "btn btn-secondary d-inline float-end ">
          <span>Groups</span>
        </div>
        <br><br>
        <div class="container">
          <div class="row">
            <div class="col-sm-3">
              <form id="groupInfo" class="form-control" action="/user/createGroup" method="post">
                <label for="groupName" class="form-label" style="font-weight: 600;">Enter Group Name</label>
                <input class="form-control" id="groupName" name="groupName" placeholder="Enter group name">
                <input class="btn btn-outline-primary ms-2 mt-2" type="submit" value="Create Group">
              </form>
            </div>
          </div>
        </div>
        <br>
        <div id="chat-window" class="col-4">
            <ul id="chat-messages">
                <!-- messages will be displayed here -->
            </ul>
        </div>
    </section>
    <section class="col-10" >
      <form id="my-form" class="form-control bg-body-tertiary"  action = '/send-message' method="post">
        
        <label for="message" class = "form-label" style="font-weight: 600;">Enter message :</label> 
        <input class="form-control" id="message" name ="message" placeholder="Enter your message">
        
        <br>
        <input class= "btn btn-outline-primary"type="submit" value="Send">
      </form>
      <ul id="chat-messages">

      </ul>
    <script src ="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js" defer></script>

    <script>
  //      const token = localStorage.getItem('token')
  //    let submit = document.addEventListener('submit', updateForm);
 
  //   function updateForm(event) {
  //     event.preventDefault();
  //    let message = document.getElementById('message').value
  //     let obj = {
  //       message: message
        
  //     }
  //     const token = localStorage.getItem('token')
  //     axios.post("http://localhost:8000/send-message", obj, { headers: { "Authorization": token } })
  //       .then((response) => {
  //         console.log(token)
  //         console.log(response.data.data)
  //         show(response.data.data)

  //       })
  //       .catch((err) => {
  //         console.log(err);
  //       })
  //   }

  //   function show(messageObj) {
  //   const chatMessages = document.getElementById('chat-messages');

  //   const messageText = document.createElement('li');
  //   messageText.textContent = messageObj.chat;
  //   console.log(messageObj.chat)
  //   chatMessages.appendChild(messageText);
  // }
 
  // window.addEventListener('DOMContentLoaded', () => {
     
  //     // const decodeToken = parseJwt(token);
  //     // console.log(decodeToken);
      
     
  //     axios
  //       .get(`http://localhost:8000/send-message`, {
  //         headers: { "Authorization": token }
  //       })
       
  //       .then((response) => {
  //         console.log(response)
  //         const userMessage = response.data.userMessage;
  //         console.log(userMessage)

  //         for (let i = 0; i < userMessage.length; i++) {
  //           show(userMessage[i]);
  //         }
         
  //       })
  //       .catch((error) => {
  //         document.body.innerHTML =
  //           document.body.innerHTML + "<h3> Something Went Wrong </h3>";
  //         console.log(error);
  //       });

  //     })

    
    let userLogged = document.querySelector("#userLogged");
let currentGroupInfo = document.querySelector("#currentGroupName");
let myForm = document.querySelector("#my-form");
let groupForm = document.querySelector("#groupInfo");
let message = document.querySelector("#message");
let chatMessage = document.querySelector("#chat-messages");
const signOutButton = document.querySelector("#sign-out-button");
let createGroupName = document.querySelector("#groupName");
let groupList = document.querySelector("#group-list");

const token = localStorage.getItem("token");
const name = localStorage.getItem("userName");
const groupName = localStorage.getItem("groupName");
const groupId = localStorage.getItem("groupId");

userLogged.innerHTML = userLogged.innerHTML + `${name}`;

// if (groupName != null) {
//   currentGroupInfo.innerHTML = currentGroupInfo.innerHTML + `${groupName}`;
// } else {
//   currentGroupInfo.innerHTML = "Select a Group";
// }

myForm.addEventListener("submit", saveToStorage);
//groupForm.addEventListener("submit", createGroup);

async function saveToStorage(e) {
  e.preventDefault();
  try {
    const userMessage = message.value;
    // const groupName = localStorage.getItem("groupName");
    // const groupId = localStorage.getItem("groupId");

    const response = await axios.post(
      `http://localhost:8000/send-message`,
      { userMessage }, 
      // , groupId
      { headers: { Authorization: token } }
    );

    getChatMessages();
  } catch (error) {
    console.log(error);
    document.body.innerHTML =
      document.body.innerHTML + "<h3> Something Went Wrong </h3>";
  }
  myForm.reset();
}
function addChatMessageOnScreen(message) {
  const messageDiv = document.createElement("div");
  messageDiv.className = "form-control";
 // console.log("massage"+message.chat)
  messageDiv.innerHTML = `<b>${name} : </b> ${message.chat}`;
  chatMessage.appendChild(messageDiv);
}


async function getChatMessages() {
  try {
    let chatMessages = JSON.parse(localStorage.getItem("chatMessages")) || [];
   // const groupId = JSON.parse(localStorage.getItem("groupId"));

    let lastMessageId;
    if (chatMessages.length > 0) {
      lastMessageId = chatMessages[chatMessages.length - 1].id;
    } else {
      lastMessageId = null;
    }
    const newMessage = await axios.get(
      `http://localhost:8000/send-message?lastMessageId=${lastMessageId}&groupId=${groupId}`,
      { headers: { Authorization: token } }
    );
   
    const newMessages = newMessage.data.userMessage
    //console.log(newMessages)

    const mergedMessages = [...chatMessages, ...newMessages];

    localStorage.setItem("chatMessages", JSON.stringify(mergedMessages));

    chatMessage.innerHTML = "";

    const filteredMessages = mergedMessages.filter((message) => {
      return message.groupId === groupId;
    });
    //console.log(newMessage)

    for (let i = 0; i < newMessages.length; i++) {
      addChatMessageOnScreen(newMessages[i]);
          }
    // filteredMessages.forEach((message) => {
    //   console.log(message);
    //   addChatMessageOnScreen(message);
    // });
  } catch (error) {
    console.log(error);
    document.body.innerHTML =
      document.body.innerHTML + "<h3> Something Went Wrong </h3>";
  }
}
window.addEventListener("DOMContentLoaded", () => {
  getChatMessages();
  // getGroups();
  // switchGroup(groupName, groupId);
});




    </script>
  </body>
</html>